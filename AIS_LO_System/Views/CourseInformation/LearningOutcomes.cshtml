@{
    ViewData["Title"] = "Learning Outcomes";

    bool canEdit = (bool)(ViewBag.CanEditLO ?? false);
    bool editMode = (bool)(ViewBag.EditMode ?? false);

    var los = (ViewBag.LearningOutcomes as List<string>) ??
              (ViewBag.LOs as List<string>) ??
              new List<string>();
}

<link rel="stylesheet" href="~/css/courseinfo.css" />

<div class="page-shell">

    <div class="top-header">
        <img class="ais-logo" src="~/images/AIS_logo.png" alt="AIS Logo" />

        <!-- ✅ FIXED: CLICKABLE BREADCRUMBS -->
        <div class="crumb">
            <a asp-controller="LecturerDashboard"
               asp-action="Index">
                Home
            </a>
            <span class="sep">/</span>
            <a asp-controller="LecturerDashboard"
               asp-action="Index"
               asp-route-year="@ViewBag.Year"
               asp-route-trimester="@ViewBag.Trimester">
                @ViewBag.Year – Tri @ViewBag.Trimester
            </a>
            <span class="sep">/</span>
            <a asp-controller="CourseDashboard"
               asp-action="Index"
               asp-route-courseCode="@ViewBag.CourseCode"
               asp-route-year="@ViewBag.Year"
               asp-route-trimester="@ViewBag.Trimester">
                @ViewBag.CourseCode
            </a>
            <span class="sep">/</span>
            <strong>Learning Outcomes</strong>
        </div>

        <a class="backlink"
           asp-controller="CourseDashboard"
           asp-action="Index"
           asp-route-courseCode="@ViewBag.CourseCode"
           asp-route-year="@ViewBag.Year"
           asp-route-trimester="@ViewBag.Trimester">
            ← Go Back
        </a>
    </div>

    <div class="content-card">
        <h2 class="page-title">Learning Outcomes</h2>

        @* Show success message if LOs were saved *@
        @if (TempData["Success"] != null)
        {
            <div class="success-msg">@TempData["Success"]</div>
        }

        @* ---------------------------
           VIEW MODE
           --------------------------- *@
        @if (!editMode)
        {
            @* ✅ FIXED: Show "No learning outcomes" when empty *@
            @if (los.Count == 0)
            {
                <div class="empty-state">
                    <p>No learning outcomes have been added yet.</p>
                </div>
            }
            else
            {
                <ol class="lo-list">
                    @foreach (var lo in los)
                    {
                        <li>@lo</li>
                    }
                </ol>
            }

            <div class="actions-center">
                @if (canEdit)
                {
                    <a class="btn-primary"
                       asp-controller="CourseInformation"
                       asp-action="EditLearningOutcomes"
                       asp-route-courseCode="@ViewBag.CourseCode"
                       asp-route-year="@ViewBag.Year"
                       asp-route-trimester="@ViewBag.Trimester">
                        @(los.Count == 0 ? "Add Learning Outcomes" : "Edit Learning Outcomes")
                    </a>
                }
                else
                {
                    <button class="btn-primary" type="button" disabled>Edit Learning Outcomes</button>
                    <div class="denied">Action Denied (permission required).</div>
                }
            </div>
        }
        else
        {
            @* ---------------------------
               EDIT MODE
               --------------------------- *@
            @if (!canEdit)
            {
                <div class="denied">Action Denied (permission required).</div>
                <div class="actions-center" style="margin-top:12px;">
                    <a class="btn-secondary"
                       asp-controller="CourseInformation"
                       asp-action="LearningOutcomes"
                       asp-route-courseCode="@ViewBag.CourseCode"
                       asp-route-year="@ViewBag.Year"
                       asp-route-trimester="@ViewBag.Trimester">
                        Back
                    </a>
                </div>
            }
            else
            {
                <form asp-controller="CourseInformation"
                      asp-action="SaveLearningOutcomes"
                      method="post">
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="courseCode" value="@ViewBag.CourseCode" />
                    <input type="hidden" name="year" value="@ViewBag.Year" />
                    <input type="hidden" name="trimester" value="@ViewBag.Trimester" />

                    <div id="loEditor">
                        @if (los.Count == 0)
                        {
                            @* Start with one empty field if no LOs exist *@
                            <div class="lo-edit-row">
                                <textarea name="outcomes" class="lo-text" placeholder="Enter learning outcome..."></textarea>
                                <button type="button" class="btn-remove" onclick="removeRow(this)">✕</button>
                            </div>
                        }
                        else
                        {
                            @for (int i = 0; i < los.Count; i++)
                            {
                                <div class="lo-edit-row">
                                    <textarea name="outcomes" class="lo-text">@los[i]</textarea>
                                    <button type="button" class="btn-remove" onclick="removeRow(this)">✕</button>
                                </div>
                            }
                        }
                    </div>

                    <div class="edit-actions">
                        <button type="button" class="btn-secondary" onclick="addRow()">+ Add LO</button>

                        <div class="right">
                            <a class="btn-secondary"
                               asp-controller="CourseInformation"
                               asp-action="LearningOutcomes"
                               asp-route-courseCode="@ViewBag.CourseCode"
                               asp-route-year="@ViewBag.Year"
                               asp-route-trimester="@ViewBag.Trimester">
                                Cancel
                            </a>

                            <button type="submit" class="btn-primary">Save</button>
                        </div>
                    </div>
                </form>

                <script>
                    function addRow() {
                        const editor = document.getElementById("loEditor");
                        const row = document.createElement("div");
                        row.className = "lo-edit-row";
                        row.innerHTML = `
                            <textarea name="outcomes" class="lo-text" placeholder="Enter learning outcome..."></textarea>
                            <button type="button" class="btn-remove" onclick="removeRow(this)">✕</button>
                        `;
                        editor.appendChild(row);
                    }

                    function removeRow(btn) {
                        btn.closest(".lo-edit-row").remove();
                    }
                </script>
            }
        }
    </div>
</div>

<style>
    /* ✅ ADDED: Styling for empty state */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-style: italic;
    }

    .success-msg {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 16px;
    }

    /* Make breadcrumb links clickable */
    .crumb a {
        color: #333;
        text-decoration: none;
    }

        .crumb a:hover {
            color: #0066cc;
            text-decoration: underline;
        }
</style>
